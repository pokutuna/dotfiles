#!/bin/sh

# git リポジトリかどうかチェック
if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: not in a git repository" >&2
    exit 1
fi

# git ルートディレクトリを取得
GIT_ROOT=$(git rev-parse --show-toplevel)

# 引数がある場合 (worktree 作成)
if [ $# -gt 0 ]; then
    # ディレクトリ名に使えない文字を "-" に置換
    WORKTREE_NAME=$(echo "$1" | sed 's/[^a-zA-Z0-9_-]/-/g')
    WORKTREE_PATH="$GIT_ROOT/.worktrees/$WORKTREE_NAME"

    # ディレクトリが既に存在するかチェック
    if [ -d "$WORKTREE_PATH" ]; then
        echo "Error: worktree '$WORKTREE_NAME' already exists" >&2
        cd '$WORKTREE_PATH'
        exit 0
    fi

    # worktree 作成 (引数の名前でブランチを作成)
    git worktree add -b "$1" "$WORKTREE_PATH" 2>/dev/null || {
        echo "Error: failed to create worktree '$WORKTREE_NAME'" >&2
        exit 1
    }

    echo "Created worktree: $WORKTREE_PATH"
    echo "cd '$WORKTREE_PATH'"

# 引数がない場合 (worktree 選択・移動)
else
    # 既存の worktree をリストアップ
    WORKTREE_LIST=$(git worktree list --porcelain | grep '^worktree ' | sed 's/^worktree //')

    if [ -z "$WORKTREE_LIST" ]; then
        echo "No worktrees found"
        exit 1
    fi

    # fzf で選択
    SELECTED_WORKTREE=$(echo "$WORKTREE_LIST" | fzf --prompt="Select worktree: ")

    if [ -n "$SELECTED_WORKTREE" ]; then
        echo "cd '$SELECTED_WORKTREE'"
    else
        echo "No worktree selected" >&2
        exit 1
    fi
fi
